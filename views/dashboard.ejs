<!DOCTYPE html>
<html lang="en">
<%- include('./partials/header') %>
<body>
  <div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h1>Weekly Schedule</h1>
      <div>
        <span class="me-3">Welcome, <%= user.username %></span>
        <a href="/logout" class="btn btn-danger">Logout</a>
      </div>
    </div>
    
    <div class="row mb-4">
      <div class="col-md-4">
        <div class="card">
          <div class="card-header bg-primary text-white">
            <h5 class="mb-0">Add New Task</h5>
          </div>
          <div class="card-body">
            <form id="taskForm">
              <div class="form-group mb-3">
                <label for="title">Title</label>
                <input type="text" class="form-control" id="title" required>
              </div>
              <div class="form-group mb-3">
                <label for="description">Description</label>
                <textarea class="form-control" id="description"></textarea>
              </div>
              <div class="form-group mb-3">
                <label for="dayOfWeek">Day of Week</label>
                <select class="form-control" id="dayOfWeek" required>
                  <option value="monday">Monday</option>
                  <option value="tuesday">Tuesday</option>
                  <option value="wednesday">Wednesday</option>
                  <option value="thursday">Thursday</option>
                  <option value="friday">Friday</option>
                  <option value="saturday">Saturday</option>
                  <option value="sunday">Sunday</option>
                </select>
              </div>
              <div class="form-check mb-3">
                <input class="form-check-input" type="checkbox" id="isRecurring" checked>
                <label class="form-check-label" for="isRecurring">
                  Recurring weekly task
                </label>
              </div>
              <button type="submit" class="btn btn-primary">Add Task</button>
            </form>
          </div>
        </div>
      </div>
      
      <div class="col-md-8">
        <ul class="nav nav-tabs" id="dayTabs" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="monday-tab" data-bs-toggle="tab" data-bs-target="#monday" type="button" role="tab">Monday</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="tuesday-tab" data-bs-toggle="tab" data-bs-target="#tuesday" type="button" role="tab">Tuesday</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="wednesday-tab" data-bs-toggle="tab" data-bs-target="#wednesday" type="button" role="tab">Wednesday</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="thursday-tab" data-bs-toggle="tab" data-bs-target="#thursday" type="button" role="tab">Thursday</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="friday-tab" data-bs-toggle="tab" data-bs-target="#friday" type="button" role="tab">Friday</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="saturday-tab" data-bs-toggle="tab" data-bs-target="#saturday" type="button" role="tab">Saturday</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="sunday-tab" data-bs-toggle="tab" data-bs-target="#sunday" type="button" role="tab">Sunday</button>
          </li>
        </ul>
        
        <div class="tab-content p-3 border border-top-0" id="dayTabsContent">
          <div class="tab-pane fade show active" id="monday" role="tabpanel">
            <div class="task-list" data-day="monday">
              <div class="text-center py-5 loading-spinner">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">Loading...</span>
                </div>
              </div>
            </div>
          </div>
          <div class="tab-pane fade" id="tuesday" role="tabpanel">
            <div class="task-list" data-day="tuesday">
              <div class="text-center py-5 loading-spinner">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">Loading...</span>
                </div>
              </div>
            </div>
          </div>
          <div class="tab-pane fade" id="wednesday" role="tabpanel">
            <div class="task-list" data-day="wednesday">
              <div class="text-center py-5 loading-spinner">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">Loading...</span>
                </div>
              </div>
            </div>
          </div>
          <div class="tab-pane fade" id="thursday" role="tabpanel">
            <div class="task-list" data-day="thursday">
              <div class="text-center py-5 loading-spinner">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">Loading...</span>
                </div>
              </div>
            </div>
          </div>
          <div class="tab-pane fade" id="friday" role="tabpanel">
            <div class="task-list" data-day="friday">
              <div class="text-center py-5 loading-spinner">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">Loading...</span>
                </div>
              </div>
            </div>
          </div>
          <div class="tab-pane fade" id="saturday" role="tabpanel">
            <div class="task-list" data-day="saturday">
              <div class="text-center py-5 loading-spinner">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">Loading...</span>
                </div>
              </div>
            </div>
          </div>
          <div class="tab-pane fade" id="sunday" role="tabpanel">
            <div class="task-list" data-day="sunday">
              <div class="text-center py-5 loading-spinner">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">Loading...</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Task Edit Modal -->
  <div class="modal fade" id="editTaskModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Edit Task</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="editTaskForm">
            <input type="hidden" id="editTaskId">
            <div class="form-group mb-3">
              <label for="editTitle">Title</label>
              <input type="text" class="form-control" id="editTitle" required>
            </div>
            <div class="form-group mb-3">
              <label for="editDescription">Description</label>
              <textarea class="form-control" id="editDescription"></textarea>
            </div>
            <div class="form-group mb-3">
              <label for="editDayOfWeek">Day of Week</label>
              <select class="form-control" id="editDayOfWeek" required>
                <option value="monday">Monday</option>
                <option value="tuesday">Tuesday</option>
                <option value="wednesday">Wednesday</option>
                <option value="thursday">Thursday</option>
                <option value="friday">Friday</option>
                <option value="saturday">Saturday</option>
                <option value="sunday">Sunday</option>
              </select>
            </div>
            <div class="form-check mb-3">
              <input class="form-check-input" type="checkbox" id="editIsRecurring">
              <label class="form-check-label" for="editIsRecurring">
                Recurring weekly task
              </label>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-danger" id="deleteTaskBtn">Delete</button>
          <button type="button" class="btn btn-primary" id="saveTaskBtn">Save changes</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Custom JavaScript for client-side functionality -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Load tasks for the active day on page load
      loadTasks('monday');
      
      // Handle tab changes
      document.querySelectorAll('#dayTabs button').forEach(tab => {
        tab.addEventListener('click', function(e) {
          const day = this.id.split('-')[0];
          loadTasks(day);
        });
      });
      
      // Form submission for adding a new task
      document.getElementById('taskForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const title = document.getElementById('title').value;
        const description = document.getElementById('description').value;
        const dayOfWeek = document.getElementById('dayOfWeek').value;
        const isRecurring = document.getElementById('isRecurring').checked;
        
        createTask(title, description, dayOfWeek, isRecurring);
      });
      
      // Save edited task
      document.getElementById('saveTaskBtn').addEventListener('click', function() {
        const id = document.getElementById('editTaskId').value;
        const title = document.getElementById('editTitle').value;
        const description = document.getElementById('editDescription').value;
        const dayOfWeek = document.getElementById('editDayOfWeek').value;
        const isRecurring = document.getElementById('editIsRecurring').checked;
        
        updateTask(id, title, description, dayOfWeek, isRecurring);
      });
      
      // Delete task
      document.getElementById('deleteTaskBtn').addEventListener('click', function() {
        const id = document.getElementById('editTaskId').value;
        deleteTask(id);
      });
    });
    
    // Load tasks for a specific day
    function loadTasks(day) {
      const taskList = document.querySelector(`.task-list[data-day="${day}"]`);
      const loadingSpinner = taskList.querySelector('.loading-spinner');
      
      if (loadingSpinner) {
        loadingSpinner.style.display = 'block';
      }
      
      fetch(`/tasks/day/${day}`)
        .then(response => response.json())
        .then(tasks => {
          if (loadingSpinner) {
            loadingSpinner.style.display = 'none';
          }
          
          if (tasks.length === 0) {
            taskList.innerHTML = '<div class="alert alert-info">No tasks for this day. Add some!</div>';
          } else {
            taskList.innerHTML = '';
            tasks.forEach(task => {
              const taskItem = document.createElement('div');
              taskItem.className = 'card mb-2';
              taskItem.innerHTML = `
                <div class="card-body">
                  <div class="d-flex justify-content-between align-items-center">
                    <div class="form-check">
                      <input class="form-check-input task-check" type="checkbox" id="task-${task._id}" 
                        data-id="${task._id}" ${task.completed ? 'checked' : ''}>
                      <label class="form-check-label ${task.completed ? 'text-decoration-line-through' : ''}" for="task-${task._id}">
                        ${task.title}
                      </label>
                    </div>
                    <div>
                      ${!task.isRecurring ? '<span class="badge bg-info me-2">One-time</span>' : ''}
                      <button class="btn btn-sm btn-outline-primary edit-task" data-id="${task._id}">
                        Edit
                      </button>
                    </div>
                  </div>
                  ${task.description ? `<p class="mb-0 mt-2 text-muted">${task.description}</p>` : ''}
                </div>
              `;
              taskList.appendChild(taskItem);
              
              // Add event listener for checkbox
              const checkbox = taskItem.querySelector(`#task-${task._id}`);
              checkbox.addEventListener('change', function() {
                toggleTaskCompletion(task._id);
              });
              
              // Add event listener for edit button
              const editBtn = taskItem.querySelector('.edit-task');
              editBtn.addEventListener('click', function() {
                openEditModal(task);
              });
            });
          }
        })
        .catch(error => {
          console.error('Error loading tasks:', error);
          taskList.innerHTML = '<div class="alert alert-danger">Error loading tasks</div>';
        });
    }
    
    // Create a new task
    function createTask(title, description, dayOfWeek, isRecurring) {
      fetch('/tasks', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          title,
          description,
          dayOfWeek,
          isRecurring
        })
      })
        .then(response => response.json())
        .then(task => {
          // Clear form
          document.getElementById('title').value = '';
          document.getElementById('description').value = '';
          
          // Reload current day's tasks
          const activeTab = document.querySelector('#dayTabs button.active');
          const activeDay = activeTab.id.split('-')[0];
          loadTasks(activeDay);
          
          // If the task is for a different day, reload that day too
          if (dayOfWeek !== activeDay) {
            loadTasks(dayOfWeek);
          }
        })
        .catch(error => {
          console.error('Error creating task:', error);
          alert('Error creating task. Please try again.');
        });
    }
    
    // Toggle task completion
    function toggleTaskCompletion(id) {
      fetch(`/tasks/${id}/toggle`, {
        method: 'PATCH'
      })
        .then(response => response.json())
        .then(task => {
          const label = document.querySelector(`label[for="task-${id}"]`);
          if (task.completed) {
            label.classList.add('text-decoration-line-through');
          } else {
            label.classList.remove('text-decoration-line-through');
          }
        })
        .catch(error => {
            console.error('Error toggling task:', error);
          alert('Error updating task. Please try again.');
          // Reset checkbox to previous state
          const checkbox = document.querySelector(`#task-${id}`);
          checkbox.checked = !checkbox.checked;
        });
    }
    
    // Open edit modal with task data
    function openEditModal(task) {
      document.getElementById('editTaskId').value = task._id;
      document.getElementById('editTitle').value = task.title;
      document.getElementById('editDescription').value = task.description || '';
      document.getElementById('editDayOfWeek').value = task.dayOfWeek;
      document.getElementById('editIsRecurring').checked = task.isRecurring;
      
      const modal = new bootstrap.Modal(document.getElementById('editTaskModal'));
      modal.show();
    }
    
    // Update task
    function updateTask(id, title, description, dayOfWeek, isRecurring) {
      fetch(`/tasks/${id}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          title,
          description,
          dayOfWeek,
          isRecurring
        })
      })
        .then(response => response.json())
        .then(task => {
          // Close modal
          const modal = bootstrap.Modal.getInstance(document.getElementById('editTaskModal'));
          modal.hide();
          
          // Reload all days that might be affected
          const currentDay = document.querySelector('#dayTabs button.active').id.split('-')[0];
          const originalDay = document.querySelector(`#task-${id}`).closest('.task-list').dataset.day;
          
          loadTasks(currentDay);
          if (dayOfWeek !== currentDay) {
            loadTasks(dayOfWeek);
          }
          if (originalDay !== currentDay && originalDay !== dayOfWeek) {
            loadTasks(originalDay);
          }
        })
        .catch(error => {
          console.error('Error updating task:', error);
          alert('Error updating task. Please try again.');
        });
    }
    
    // Delete task
    function deleteTask(id) {
      if (confirm('Are you sure you want to delete this task?')) {
        fetch(`/tasks/${id}`, {
          method: 'DELETE'
        })
          .then(response => response.json())
          .then(data => {
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('editTaskModal'));
            modal.hide();
            
            // Reload current day's tasks
            const activeTab = document.querySelector('#dayTabs button.active');
            const activeDay = activeTab.id.split('-')[0];
            loadTasks(activeDay);
            
            // Also reload the day the task was associated with
            const originalDay = document.querySelector(`#task-${id}`).closest('.task-list')?.dataset.day;
            if (originalDay && originalDay !== activeDay) {
              loadTasks(originalDay);
            }
          })
          .catch(error => {
            console.error('Error deleting task:', error);
            alert('Error deleting task. Please try again.');
          });
      }
    }
    document.addEventListener('DOMContentLoaded', function() {
  // Get current day of week (0 = Sunday, 1 = Monday, ..., 6 = Saturday)
  const today = new Date().getDay();
  
  // Map JavaScript day index to our day names
  // JavaScript uses 0 for Sunday, but our app uses 'sunday' as the string value
  const dayMap = {
    0: 'sunday',   // Sunday
    1: 'monday',   // Monday
    2: 'tuesday',  // Tuesday
    3: 'wednesday',// Wednesday
    4: 'thursday', // Thursday
    5: 'friday',   // Friday
    6: 'saturday'  // Saturday
  };
  
  const currentDay = dayMap[today];
  
  // Find the tab for the current day and activate it
  const currentDayTab = document.getElementById(`${currentDay}-tab`);
  if (currentDayTab) {
    // Using Bootstrap 5 Tab API to activate the current day tab
    const tab = new bootstrap.Tab(currentDayTab);
    tab.show();
    
    // Load tasks for the current day
    loadTasks(currentDay);
  }
});
  </script>
<%- include('./partials/footer') %>
</body>
</html>